

## üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–µ–≤–æ–π (`vCSAxis`) ‚Äî –∏–∑ `vCSAxis.h` –∏ `vCS_DM_Axis.h`

```cpp
class vCSAxis : public AcDbEntity {
    // ...
    AcDbObjectIdArray m_SegArray;       // ‚Üê —Å–µ–≥–º–µ–Ω—Ç—ã: vCSSegment
    AcDbObjectIdArray m_SupArray;       // ‚Üê –æ–ø–æ—Ä—ã: vCSSupport
    // ‚ùó –ù–ï–¢ m_InLineArray!
};
```

‚Üí –û–ø–æ—Ä—ã (`vCSSupport`) **—Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –æ—Å–µ–≤–æ–π** ‚Äî `vCSAxis::appendSupport()` ‚Üí `m_SupArray.append(id)`.

–ê **–∏–Ω–ª–∞–π–Ω—ã ‚Äî –Ω–µ—Ç**.

---

## üì¶ –ì–¥–µ –∂–µ —Ö—Ä–∞–Ω—è—Ç—Å—è `vCSInLine`?

–í–æ—Ç –∏—Å—Ç–∏–Ω–∞:

| –û–±—ä–µ–∫—Ç | –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Å—ã–ª–∫–∞ | –ö—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ lifecycle |
|--------|---------------------|----------------------------|
| `vCSSegment` | `vCSAxis::m_SegArray` | `vCSAxis` |
| `vCSSupport` | `vCSAxis::m_SupArray` | `vCSAxis` |
| `vCSInLine` | **`vCSSegment::m_InLineArray`** | **`vCSSegment`** |

–ò–∑ `vCSSegment.h`:
```cpp
class vCSSegment : public AcDbEntity {
    // ...
    AcDbObjectIdArray m_InLineArray;    // ‚Üê –¢–û–õ–¨–ö–û –∑–¥–µ—Å—å!
    void insertInlineItem(const AcDbObjectId& id, int nPos = -1, AcDb::DuplicateRecordCloning = AcDb::kDrcIgnore);
};
```

‚Üí **`vCSInLine` ‚Äî –¥–æ—á–µ—Ä–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç `vCSSegment`, –∞ –Ω–µ `vCSAxis`**.

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?

### ‚úÖ –û–ø–æ—Ä–∞ (`vCSSupport`)
1. –¢—ã —Å–æ–∑–¥–∞—ë—à—å `vCSSupport *pSup = new vCSSupport();`
2. `pSup->postToDb(...)`
3. `pAxis->appendSupport(idSup)` ‚Üí –æ—Å–µ–≤–∞—è –±–µ—Ä—ë—Ç –≤–ª–∞–¥–µ–Ω–∏–µ
4. –ü—Ä–∏ `pAxis->worldDraw()` ‚Üí –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç **–∏ —Å–µ–≥–º–µ–Ω—Ç—ã, –∏ –æ–ø–æ—Ä—ã**
5. –ü—Ä–∏ `pAxis->detachFromDatabase()` ‚Üí –æ—Å–µ–≤–∞—è —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ –æ–ø–æ—Ä—ã

‚Üí **–í—Å—ë —Å—Ç–∞–±–∏–ª—å–Ω–æ**, –ø–æ—Ç–æ–º—É —á—Ç–æ `vCSAxis` –∑–Ω–∞–µ—Ç –ø—Ä–æ –æ–ø–æ—Ä—ã.

---

### ‚ùå –ò–Ω–ª–∞–π–Ω (`vCSInLine`)
1. –¢—ã —Å–æ–∑–¥–∞—ë—à—å `vCSInLine *pIL = new vCSInLine();`
2. `pIL->postToDb(...)`
3. ...–∏ **–Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—à—å** –≤ `vCSSegment::m_InLineArray`
4. –ü—Ä–∏ `pAxis->worldDraw()`:
   - –æ—Å–µ–≤–∞—è **–Ω–µ –∑–Ω–∞–µ—Ç** –ø—Ä–æ `pIL`
   - –Ω–æ `vCSSegment::worldDraw()` **–¥–æ–ª–∂–µ–Ω** –≤—ã–∑–≤–∞—Ç—å `pIL->worldDraw()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `id` –∏–∑ `m_InLineArray`
   - ‚Üí `m_InLineArray` –ø—É—Å—Ç ‚Üí –∏–Ω–ª–∞–π–Ω **–Ω–µ —Ä–∏—Å—É–µ—Ç—Å—è**, –Ω–æ‚Ä¶
5. –ü—Ä–∏ `acedSSGet()` –∏–ª–∏ `gripPoints`:
   - AutoCAD –Ω–∞—Ö–æ–¥–∏—Ç `vCSInLine` –≤ –±–∞–∑–µ
   - –≤—ã–∑—ã–≤–∞–µ—Ç `pIL->getGripPoints()`
   - –≤–Ω—É—Ç—Ä–∏: `GetStartPoint()` ‚Üí `GetAxis()->GetNodeAt(m_nNodeIndex)`  
     –Ω–æ `m_nNodeIndex == -1` (–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!) ‚Üí —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ `nullptr` ‚Üí **–∫—Ä–∞—à**

---

## ‚úÖ –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å `vCSInLine` ‚Äî **–ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ**

–¢–µ–±–µ **–Ω–µ –Ω—É–∂–Ω–æ** `vCSDragManager`, **–Ω–µ –Ω—É–∂–Ω–æ** XML ‚Äî —Ç–æ–ª—å–∫–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ–≥–º–µ–Ω—Ç—É**.



```cpp
bool CreateInlineLowLevel(
    const AcDbObjectId& idSegment,
    double distFromStart,
    double dn1 = 100.0,
    double dn2 = 100.0)
{
    // 1. –û—Ç–∫—Ä—ã—Ç—å —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
    AcDbObjectPointer<vCSSegment> pSeg(idSegment, AcDb::kForWrite);
    if (!pSeg.openStatus()) return false;

    // 2. –°–æ–∑–¥–∞—Ç—å –∏–Ω–ª–∞–π–Ω ‚Äî –í–ê–ñ–ù–û: –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥–∞—Ç—å id –æ—Å–µ–≤–æ–π!
    vCSInLine* pIL = new vCSInLine(pSeg->GetAxisId());
    // ‚Üê –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: m_idAxis = pSeg->GetAxisId(), m_nNodeIndex = -1 (–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ)

    AcDbObjectId idIL;
    AcTransaction* pTr = acTransactionManager->startTransaction();
    if (!pTr) { delete pIL; return false; }

    pTr->addNewlyCreatedDBRObject(pIL);
    AcDbBlockTableRecord* pBtr = nullptr;
    acdbHostApplicationServices()->workingDatabase()
        ->getSymbolTableRecord(pBtr, AcDb::kForWrite);
    pBtr->appendAcDbEntity(pIL);
    pBtr->close();

    // 3. –ü—Ä–æ—Ñ–∏–ª–∏ ‚Äî –ª—É—á—à–µ —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É (–Ω–æ –º–æ–∂–Ω–æ –∏ new, –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å, –∫–∞–∫ —É–¥–∞–ª–∏—Ç—å)
    vCSProfilePtr pProf1 = vCSDragManager::createProfile(
        vCSProfileCircle::GetStaticClass(), dn1);
    vCSProfilePtr pProf2 = vCSDragManager::createProfile(
        vCSProfileCircle::GetStaticClass(), dn2);

    pIL->SetProfile1(pProf1);
    pIL->SetProfile2(pProf2);
    pIL->SetSegmentId(idSegment);
    pIL->SetDistanceFromPrev(distFromStart);  // ‚Üê —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ m_nNodeIndex!

    // 4. üîë –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π —à–∞–≥: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–µ–≥–º–µ–Ω—Ç–µ
    pSeg->insertInlineItem(idIL, -1);  // -1 = –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞

    // 5. –û–±–Ω–æ–≤–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é (–≤—ã–∑–æ–≤–µ—Ç PE_SetPosition ‚Üí –ø–æ—Å—Ç—Ä–æ–∏—Ç mesh)
    pIL->PE_Rebuild_SetPosition();

    pTr->endTransaction();

    acutPrintf(L"\n‚úÖ vCSInLine —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–µ–≥–º–µ–Ω—Ç—É");
    return true;
}
```

---

## üîé –ü–æ—á–µ–º—É `pIL->SetDistanceFromPrev(dist)` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ?

–í–Ω—É—Ç—Ä–∏ `vCSInLine::SetDistanceFromPrev()`:

```cpp
// vCSInLine.cpp (–ø—Å–µ–≤–¥–æ–∫–æ–¥)
void vCSInLine::SetDistanceFromPrev(double d) {
    m_dDistFromPrev = d;
    if (!m_idSegment.isNull()) {
        AcDbObjectPointer<vCSSegment> pSeg(m_idSegment, AcDb::kForRead);
        if (pSeg) {
            m_nNodeIndex = pSeg->FindNodeIndexByDistance(d); // ‚Üê –≤—ã—á–∏—Å–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å —É–∑–ª–∞!
        }
    }
}
```

‚Üí –ë–µ–∑ —ç—Ç–æ–≥–æ `m_nNodeIndex == -1` ‚Üí `GetStartPoint()` ‚Üí `pAxis->GetNodeAt(-1)` ‚Üí `nullptr` ‚Üí **–∫—Ä–∞—à**.

---



```cpp
AcDbObjectPointer<vCSInLine> pIL(idIL, AcDb::kForRead);
if (pIL) {
    acutPrintf(L"\nüîπ m_idAxis = %s", pIL->GetAxisId().asOldId().toString());
    acutPrintf(L"\nüîπ m_idSegment = %s", pIL->GetSegmentId().asOldId().toString());
    acutPrintf(L"\nüîπ m_nNodeIndex = %d", pIL->getNodeIndex());
    acutPrintf(L"\nüîπ m_dDistFromPrev = %.1f", pIL->GetDistanceFromPrev());
    acutPrintf(L"\nüîπ Prof1 DN = %.1f", pIL->GetDN1());
}
```

–ï—Å–ª–∏ `m_nNodeIndex >= 0` –∏ `m_idAxis/m_idSegment` –Ω–µ null ‚Äî **–≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ**, –∫—Ä–∞—à–∞ –Ω–µ –±—É–¥–µ—Ç.

---

## üß© TL;DR ‚Äî —á—Ç–æ —Ç—ã, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, 

| –î–µ–π—Å—Ç–≤–∏–µ | –¢–≤–æ—è –≤–µ—Ä—Å–∏—è | –ü—Ä–∞–≤–∏–ª—å–Ω–æ |
|---------|-------------|-----------|
| –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä | `new vCSInLine()` | `new vCSInLine(pSeg->GetAxisId())` |
| –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ–≥–º–µ–Ω—Ç—É | ‚ùå –ø—Ä–æ–ø—É—â–µ–Ω–æ | `pSeg->insertInlineItem(idIL)` |
| –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è | `m_dDistFromPrev = d` (–Ω–∞–ø—Ä—è–º—É—é) | `pIL->SetDistanceFromPrev(d)` |
| –ü—Ä–æ—Ñ–∏–ª–∏ | `pIL->SetProfile1(new vCSProfileCircle(...))` | `vCSDragManager::createProfile(...)` ‚Äî –∏–ª–∏ `delete` –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ |

---
